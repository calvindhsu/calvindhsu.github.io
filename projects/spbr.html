
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Physically Based Path Tracer - visual output</title>
  <meta name="author" content="Calvin Hsu">

  
  <meta name="description" content="Physically Based Path Tracer Physically Based Path Tracer Scene acknowledgements: Crytek Sponza Atrium scene is modeled by Frank Meinl. Scene data &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://calvindhsu.github.io/projects/spbr.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="visual output" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans+Caption:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- Load jQuery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
    jQuery.noConflict(); // ender.js conflicts with jQuery
</script>
 
<!-- Load FancyBox -->
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" />
<script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
 
<!-- Fix FancyBox style for OctoPress -->
<style type="text/css">
  .fancybox-wrap { position: fixed !important; }
  .fancybox-opened {
    -webkit-border-radius: 4px !important;
       -moz-border-radius: 4px !important;
            border-radius: 4px !important;
  }
  .fancybox-close, .fancybox-prev span, .fancybox-next span {
    background-color: transparent !important;
    border: 0 !important;
  }
</style>

 
<!-- Custom Scripts -->
<script language="Javascript" type="text/javascript">
    // ender.js gobbles jQuery's ready event: Use ender.js $ instead
    $(document).ready(function() {
                    jQuery(".fancybox").fancybox();
                        });
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-46211723-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">visual output</a></h1>
  
    <h2>journey of a game and graphics developer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:calvindhsu.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/about">About</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://www.linkedin.com/in/calvinhsu">Linkedin</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article role="article">
  
  <header>
    <h1 class="entry-title">Physically Based Path Tracer</h1>
    
  </header>
  
  <h3>Physically Based Path Tracer</h3>

<ul class="gallery">
<li><a href="/images/projects/spbr/sponza-day.png" class="fancybox" rel="gallery-6b231f400cb18b9401565c7e32903225" title="Crytek Sponza Environment + Directional light"><img src="/images/projects/spbr/sponza-day_m.png" alt="Crytek Sponza Environment + Directional light" /></a></li><li><a href="/images/projects/spbr/sponza-night.png" class="fancybox" rel="gallery-6b231f400cb18b9401565c7e32903225" title="Crytek Sponza 18 point lights, 1 directional moon-light"><img src="/images/projects/spbr/sponza-night_m.png" alt="Crytek Sponza 18 point lights, 1 directional moon-light" /></a></li><li><a href="/images/projects/spbr/spheres-close.png" class="fancybox" rel="gallery-6b231f400cb18b9401565c7e32903225" title="Cornell Box 1 point light"><img src="/images/projects/spbr/spheres-close_m.png" alt="Cornell Box 1 point light" /></a></li><li><a href="/images/projects/spbr/spheres-front.png" class="fancybox" rel="gallery-6b231f400cb18b9401565c7e32903225" title="Cornell Box 1 point light"><img src="/images/projects/spbr/spheres-front_m.png" alt="Cornell Box 1 point light" /></a></li>
</ul>


<p><em>Scene acknowledgements: Crytek Sponza Atrium scene is modeled by Frank Meinl. Scene data obtained from <a href="http://graphics.cs.williams.edu/data/meshes.xml">Morgan Mcguire</a></em></p>

<p>A project I started with a friend to do some heavy graphics programming from scratch and later continued on my own. We started by reading and implenting core features of <a href="http://www.pbrt.org">Physically Based Rendering (PBRT)</a> by Matt Pharr and Greg Humphreys.</p>

<h4>Stats</h4>

<ul>
<li>Time: 2.5 months (09/13-11/13)</li>
<li>Technologies: C++11, CUDA, CMake</li>
<li>Platform: Linux</li>
<li>Team-Size: 2 => 1</li>
</ul>


<h4>Features</h4>

<p><strong>Acceleration Structure: SBVH Split Bounding Volume Hierarchy</strong></p>

<p>A problem we saw was that our BVH implementation was only accelerating very uniformly tessellated scenes. I.e. like the teapot or the Stanford dragon. However, Sponza atrium and other scenes are more realistic, and it would be good practice to be able to handle those scenes efficiently.</p>

<p>The previous object split BVH took way too long to even get one 1 sample per pixel for a 640x480 image. After SBVH was implemented this pass took on the order of 20s, I could finally see an interactive preview and generate some images!</p>

<p>References: <a href="http://www.nvidia.com/docs/IO/77714/sbvh.pdf">Stich &lsquo;09</a></p>

<p><strong>CPU/GPU Wavefront Formulation</strong></p>

<p>As the first step to building a GPU path tracer, I decided to rework my renderer to process many paths in parallel. I was lucky enough to attend a talk by Tero Karras at SIGGRAPH&#8217;13 that describe the wavefront formulation for path tracing. This approach seemed to make a lot of sense: extend all paths by 1 ray/bounce at a time and group similar operations together in parallel, resulting in execution coherence.</p>

<p>As a first step I kept most of my CPU code and only ray traversals GPU accelerated. This was a good bit of work already to transform BVH structures into a GPU-friendly format, and also to be able to unwrap the renderer loop of processing 1 path many bounces, to many paths 1 bounce.</p>

<p>In the end using the GPU even just for ray traversals brought down the render time for the 720p Sponza scene from 9hr single threaded CPU implementation to 2hr wavefront implementation.</p>

<p>References:</p>

<ul>
<li><a href="https://research.nvidia.com/publication/megakernels-considered-harmful-wavefront-path-tracing-GPUs">Laine Karras &lsquo;13</a></li>
<li><a href="http://www.nvidia.com/object/nvidia_research_pub_011.html">Aila Laine &lsquo;09</a></li>
</ul>


<p><strong>Efficiency features</strong></p>

<p>The following were more for own sanity while developing and debugging. Part of the problem in building an offline renderer is that you would waste all this time waiting for your image to come out, when really your camera was positioned incorrectly or your lights weren&rsquo;t bright enough.</p>

<p><strong>Progressive preview:</strong> loop over all pixels with 1 sample instead of each pixel with all samples. Measure time between processing batches of samples, if 100ms has elapsed display the current raster to the screen.</p>

<p><strong>Blender scene format:</strong> I integrated, then contributed to the <a href="http://github.com/assimp">Open Asset Importer</a>. It served my purposes well for allowing me to place camera, lights and repositioning them. However, it&rsquo;s quickly reached it&rsquo;s limits for describing the materials and more complicated lights, that I will likely need to move to using my own exporter or custom importer. Either way, scene set-up should never happen via text file</p>

<p><strong>Partial scene reloading:</strong> building the SBVH for large scenes can be costly, and isn&rsquo;t necessary if you just move lights around, change brightness, or adjust the camera. I added a button to reload those parts and restart rendering without rebuilding the BVH. This allowed for more minor adjustments.</p>

<p><strong>Pixel debugging:</strong> If there was a weird pixel in the output, it was easy enough to report the position of the pixel, which could be used to limit the render window from command line while running in a debugger. This allowed me to pinpoint problems without running across all of the other computation.</p>

  
    <footer>
      
      
        <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://calvindhsu.github.io/projects/spbr.html" data-via="" data-counturl="http://calvindhsu.github.io/projects/spbr.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

      
    </footer>
  
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/12/06/cuda-vs-opencl/">CUDA vs OpenCL Development Experience on an NVIDIA GPU</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/05/project-reflections/">Project Reflections</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/03/debugging-variance/">Debugging Variance: Mistakes and Lessons</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Calvin Hsu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>. Design by <a href="http://octopressthemes.com">Octopress Themes</a>.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'visualoutput';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://calvindhsu.github.io/projects/spbr.html';
        var disqus_url = 'http://calvindhsu.github.io/projects/spbr.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
